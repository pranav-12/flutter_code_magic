# Flutter Code Magic - Codemagic CI/CD Configuration
#
# Required Environment Variables in Codemagic:
# 
# Google Drive Integration:
# - GOOGLE_DRIVE_SERVICE_ACCOUNT: Service account JSON for Google Drive API
#   Service Account Email: edge-app-cicd@codemagic-470112.iam.gserviceaccount.com
# - GOOGLE_DRIVE_FOLDER_ID: Google Drive folder ID where files will be uploaded
#   Folder ID: 1GNT1C0eOcg0hgsxr6lqIKx-LwZK77BBF
#
# Slack Integration:
# - SLACK_WEBHOOK_URL: Slack webhook URL for notifications
#
# Diawi Integration (iOS only):
# - DIAWI_TOKEN: Diawi API token for iOS app distribution
#
# Android Signing:
# - SKIPPED: Using debug signing for development builds
#
# iOS Signing:
# - SKIPPED: Using --no-codesign for development builds

workflows:
  # ANDROID BUILD WORKFLOW
  android-workflow:
    name: Android Build
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      groups:
        - google_credentials  # Optional: for Google Drive uploads
        - slack_credentials   # Optional: for Slack notifications
      vars:
        PACKAGE_NAME: "com.example.flutter_code_magic"
      flutter: stable
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
        - pattern: 'develop'
          include: true
          source: true
        - pattern: 'feature/*'
          include: true
          source: true
    scripts:
      - name: Extract version from pubspec.yaml
        script: |
          # Extract version from pubspec.yaml
          FULL_VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2)
          VERSION_NAME=$(echo $FULL_VERSION | cut -d '+' -f 1)
          VERSION_CODE=$(echo $FULL_VERSION | cut -d '+' -f 2)
          
          echo "VERSION_NAME=$VERSION_NAME" >> $CM_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $CM_ENV
          
          echo "ðŸ“¦ Building version: $VERSION_NAME+$VERSION_CODE"
      - name: Set up local.properties
        script: |
          echo "flutter.versionName=$VERSION_NAME" > $CM_BUILD_DIR/android/local.properties
          echo "flutter.versionCode=$VERSION_CODE" >> $CM_BUILD_DIR/android/local.properties
      - name: Build APK
        script: |
          flutter build apk --release
          cd build/app/outputs/flutter-apk
          mv app-release.apk flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.apk
      - name: Upload to Google Drive
        script: |
          # Check if Google Drive is configured
          if [ -z "$GOOGLE_DRIVE_SERVICE_ACCOUNT" ] || [ -z "$GOOGLE_DRIVE_FOLDER_ID" ]; then
            echo "âš ï¸ Google Drive not configured, skipping upload"
            echo "ðŸ’¡ To enable Google Drive uploads, configure google_credentials environment group"
            echo "DRIVE_LINK=Not_configured" >> $CM_ENV
            exit 0
          fi
          
          # Install gdrive CLI tool
          curl -L https://github.com/gdrive-org/gdrive/releases/download/2.1.1/gdrive_2.1.1_darwin_amd64.tar.gz | tar xz
          sudo mv gdrive /usr/local/bin/
          
          # Authenticate and upload
          echo "$GOOGLE_DRIVE_SERVICE_ACCOUNT" > service-account.json
          gdrive account add --service-account service-account.json
          gdrive files upload "build/app/outputs/flutter-apk/flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.apk" --parent "$GOOGLE_DRIVE_FOLDER_ID"
          
          echo "DRIVE_LINK=https://drive.google.com/drive/folders/$GOOGLE_DRIVE_FOLDER_ID" >> $CM_ENV
      - name: Send Slack notification
        script: |
          # Check if Slack webhook is configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            echo "ðŸ’¡ To enable Slack notifications, add SLACK_WEBHOOK_URL to slack_credentials environment group"
            exit 0
          fi
          
          APK_PATH="build/app/outputs/flutter-apk/flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.apk"
          SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH" 2>/dev/null)
          SIZE_MB=$(($SIZE/1024/1024))
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ðŸš€ *Flutter Code Magic Android Build Completed*\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ðŸ“± Flutter Code Magic Android v${VERSION_NAME}+${VERSION_CODE}\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Platform:* Android\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Version:* ${VERSION_NAME}+${VERSION_CODE}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Size:* ${SIZE_MB}MB\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:* $CM_BRANCH\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"ðŸ“ *Google Drive:* ${DRIVE_LINK:-Not configured}\\nðŸ“± *File:* flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.apk\"
                  }
                }
              ]
            }" \
            "$SLACK_WEBHOOK_URL"
    artifacts:
      - build/app/outputs/flutter-apk/*.apk

  # iOS BUILD WORKFLOW
  ios-workflow:
    name: iOS Build
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      groups:
        - google_credentials  # Optional: for Google Drive uploads
        - slack_credentials   # Optional: for Slack notifications
        - diawi_credentials   # Optional: for Diawi distribution
      vars:
        PACKAGE_NAME: "com.example.flutterCodeMagic"
        BUNDLE_ID: "com.example.flutterCodeMagic"
      flutter: stable
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
        - pattern: 'develop'
          include: true
          source: true
        - pattern: 'feature/*'
          include: true
          source: true
    scripts:
      - name: Extract version from pubspec.yaml
        script: |
          # Extract version from pubspec.yaml
          FULL_VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2)
          VERSION_NAME=$(echo $FULL_VERSION | cut -d '+' -f 1)
          VERSION_CODE=$(echo $FULL_VERSION | cut -d '+' -f 2)
          
          echo "VERSION_NAME=$VERSION_NAME" >> $CM_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $CM_ENV
          
          echo "ðŸ“¦ Building version: $VERSION_NAME+$VERSION_CODE"

      - name: Build iOS
        script: |
          # Build iOS app without signing
          flutter build ios --release --no-codesign
          
          # Create ipa directory
          mkdir -p build/ios/ipa
          
          # Package the app as a simple zip (for distribution)
          cd build/ios/Release-iphoneos/
          zip -r ../ipa/flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.ipa Runner.app
          
          echo "âœ… iOS app packaged as IPA"

      - name: Upload to Google Drive
        script: |
          # Check if Google Drive is configured
          if [ -z "$GOOGLE_DRIVE_SERVICE_ACCOUNT" ] || [ -z "$GOOGLE_DRIVE_FOLDER_ID" ]; then
            echo "âš ï¸ Google Drive not configured, skipping upload"
            echo "ðŸ’¡ To enable Google Drive uploads, configure google_credentials environment group"
            echo "DRIVE_LINK=Not_configured" >> $CM_ENV
            exit 0
          fi
          
          # Install gdrive CLI tool
          curl -L https://github.com/gdrive-org/gdrive/releases/download/2.1.1/gdrive_2.1.1_darwin_amd64.tar.gz | tar xz
          sudo mv gdrive /usr/local/bin/
          
          # Authenticate with service account
          echo "$GOOGLE_DRIVE_SERVICE_ACCOUNT" > service-account.json
          gdrive account add --service-account service-account.json
          
          # Upload IPA and get file ID
          echo "ðŸ“¤ Uploading IPA to Google Drive..."
          UPLOAD_OUTPUT=$(gdrive files upload build/ios/ipa/flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.ipa --parent $GOOGLE_DRIVE_FOLDER_ID)
          FILE_ID=$(echo "$UPLOAD_OUTPUT" | grep "Uploaded" | awk '{print $2}')
          DRIVE_LINK="https://drive.google.com/file/d/$FILE_ID/view"
          echo "DRIVE_LINK=$DRIVE_LINK" >> $CM_ENV
          echo "âœ… IPA uploaded to Google Drive: $DRIVE_LINK"
      - name: Upload to Diawi
        script: |
          # Check if Diawi is configured
          if [ -z "$DIAWI_TOKEN" ]; then
            echo "âš ï¸ Diawi not configured, skipping upload"
            echo "ðŸ’¡ To enable Diawi uploads, configure diawi_credentials environment group"
            exit 0
          fi
          
          IPA_PATH="build/ios/ipa/flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.ipa"
          
          # Upload to Diawi
          echo "ðŸ“¤ Uploading IPA to Diawi..."
          RESPONSE=$(curl -F "token=$DIAWI_TOKEN" \
                          -F "file=@$IPA_PATH" \
                          -F "find_by_udid=1" \
                          -F "wall_of_apps=1" \
                          https://upload.diawi.com/)
          
          JOB_ID=$(echo $RESPONSE | grep -o '"job":"[^"]*' | cut -d'"' -f4)
          echo "Diawi Job ID: $JOB_ID"
          
          # Wait for upload to complete and get link
          sleep 30
          for i in {1..10}; do
            STATUS_RESPONSE=$(curl -s https://upload.diawi.com/status?token=$DIAWI_TOKEN\&job=$JOB_ID)
            if echo $STATUS_RESPONSE | grep -q '"status":2000'; then
              DIAWI_LINK=$(echo $STATUS_RESPONSE | grep -o '"link":"[^"]*' | cut -d'"' -f4)
              echo "DIAWI_LINK=$DIAWI_LINK" >> $CM_ENV
              break
            fi
            sleep 10
          done
      - name: Send Slack notification
        script: |
          # Check if Slack webhook is configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            echo "ðŸ’¡ To enable Slack notifications, add SLACK_WEBHOOK_URL to slack_credentials environment group"
            exit 0
          fi
          
          IPA_PATH="build/ios/ipa/flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.ipa"
          SIZE=$(stat -f%z "$IPA_PATH" 2>/dev/null || stat -c%s "$IPA_PATH" 2>/dev/null)
          SIZE_MB=$(($SIZE/1024/1024))
          
          DIAWI_TEXT=""
          if [ ! -z "$DIAWI_LINK" ]; then
            DIAWI_TEXT="ðŸ“² *Diawi Link:* <$DIAWI_LINK|Install on Device>\\n"
          fi
          
          echo "ðŸ“¤ Sending Slack notification..."
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ðŸš€ *Flutter Code Magic iOS Build Completed*\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ðŸ“± Flutter Code Magic iOS v${VERSION_NAME}+${VERSION_CODE}\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Platform:* iOS\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Version:* ${VERSION_NAME}+${VERSION_CODE}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Size:* ${SIZE_MB}MB\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:* $CM_BRANCH\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"ðŸ“ *Google Drive:* ${DRIVE_LINK:-Not configured}\\n${DIAWI_TEXT}ðŸ“± *File:* flutter_code_magic_v${VERSION_NAME}+${VERSION_CODE}.ipa\"
                  }
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL
    artifacts:
      - build/ios/ipa/*.ipa

  # WEB BUILD WORKFLOW
  web-workflow:
    name: Web Build
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      groups:
        - google_credentials  # Optional: for Google Drive uploads
        - slack_credentials   # Optional: for Slack notifications
      vars:
        PACKAGE_NAME: "com.example.flutter_code_magic"
      flutter: stable
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
        - pattern: 'develop'
          include: true
          source: true
        - pattern: 'feature/*'
          include: true
          source: true
    scripts:
      - name: Extract version from pubspec.yaml
        script: |
          # Extract version from pubspec.yaml
          FULL_VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2)
          VERSION_NAME=$(echo $FULL_VERSION | cut -d '+' -f 1)
          VERSION_CODE=$(echo $FULL_VERSION | cut -d '+' -f 2)
          
          echo "VERSION_NAME=$VERSION_NAME" >> $CM_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $CM_ENV
          
          echo "ðŸ“¦ Building version: $VERSION_NAME+$VERSION_CODE"
      - name: Build Web
        script: |
          flutter build web --release
      - name: Package Web Build
        script: |
          cd build/web
          tar -czf ../flutter_code_magic_web_v${VERSION_NAME}+${VERSION_CODE}.tar.gz .

      - name: Upload to Google Drive
        script: |
          # Check if Google Drive is configured
          if [ -z "$GOOGLE_DRIVE_SERVICE_ACCOUNT" ] || [ -z "$GOOGLE_DRIVE_FOLDER_ID" ]; then
            echo "âš ï¸ Google Drive not configured, skipping upload"
            echo "ðŸ’¡ To enable Google Drive uploads, configure google_credentials environment group"
            exit 0
          fi
          
          # Install gdrive CLI tool
          curl -L https://github.com/gdrive-org/gdrive/releases/download/2.1.1/gdrive_2.1.1_darwin_amd64.tar.gz | tar xz
          sudo mv gdrive /usr/local/bin/
          
          # Authenticate with service account
          echo "$GOOGLE_DRIVE_SERVICE_ACCOUNT" > service-account.json
          gdrive account add --service-account service-account.json
          
          # Upload Web build
          echo "ðŸ“¤ Uploading Web build to Google Drive..."
          gdrive files upload build/flutter_code_magic_web_v${VERSION_NAME}+${VERSION_CODE}.tar.gz --parent $GOOGLE_DRIVE_FOLDER_ID
      - name: Send Slack notification
        script: |
          # Check if Slack webhook is configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            echo "ðŸ’¡ To enable Slack notifications, add SLACK_WEBHOOK_URL to slack_credentials environment group"
            exit 0
          fi
          
          WEB_PATH="build/flutter_code_magic_web_v${VERSION_NAME}+${VERSION_CODE}.tar.gz"
          SIZE=$(stat -f%z "$WEB_PATH" 2>/dev/null || stat -c%s "$WEB_PATH" 2>/dev/null)
          SIZE_MB=$(($SIZE/1024/1024))
          
          echo "ðŸ“¤ Sending Slack notification..."
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ðŸš€ *Flutter Code Magic Web Build Completed*\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ðŸŒ Flutter Code Magic Web v${VERSION_NAME}+${VERSION_CODE}\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Platform:* Web\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Version:* ${VERSION_NAME}+${VERSION_CODE}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Size:* ${SIZE_MB}MB\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:* $CM_BRANCH\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"ðŸ“ *Google Drive:* Web build uploaded successfully\\nðŸŒ *File:* flutter_code_magic_web_v${VERSION_NAME}+${VERSION_CODE}.tar.gz\"
                  }
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL
    artifacts:
      - build/*.tar.gz

  # COMBINED BUILD WORKFLOW (All platforms)
  all-platforms:
    name: Build All Platforms
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      groups:
        - google_credentials  # Optional
        - slack_credentials   # Optional
        - diawi_credentials   # Optional
      vars:
        PACKAGE_NAME: "com.example.flutter_code_magic"
        BUNDLE_ID: "com.example.flutterCodeMagic"
      flutter: stable
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - tag  # Trigger on version tags
      tag_patterns:
        - pattern: 'v*'
          include: true
    scripts:
      - name: Extract version from pubspec.yaml
        script: |
          FULL_VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2)
          VERSION_NAME=$(echo $FULL_VERSION | cut -d '+' -f 1)
          VERSION_CODE=$(echo $FULL_VERSION | cut -d '+' -f 2)
          
          echo "VERSION_NAME=$VERSION_NAME" >> $CM_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $CM_ENV
          
          echo "ðŸ“¦ Building all platforms for version: $VERSION_NAME+$VERSION_CODE"
      - name: Build Android APK
        script: |
          echo "flutter.versionName=$VERSION_NAME" > $CM_BUILD_DIR/android/local.properties
          echo "flutter.versionCode=$VERSION_CODE" >> $CM_BUILD_DIR/android/local.properties
          
          # Build unsigned release APK
          flutter build apk --release --no-shrink
          
          cd build/app/outputs/flutter-apk
          mv app-release.apk flutter_code_magic_android_v${VERSION_NAME}+${VERSION_CODE}.apk
      - name: Build iOS
        script: |
          cd ios && pod install && cd ..
          
          # Build iOS app without signing
          flutter build ios --release --no-codesign
          
          # Create ipa directory and package
          mkdir -p build/ios/ipa
          cd build/ios/Release-iphoneos/
          zip -r ../ipa/flutter_code_magic_ios_v${VERSION_NAME}+${VERSION_CODE}.ipa Runner.app
      - name: Build Web
        script: |
          flutter build web --release
          cd build/web
          tar -czf ../flutter_code_magic_web_v${VERSION_NAME}+${VERSION_CODE}.tar.gz .

    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - build/ios/ipa/*.ipa
      - build/*.tar.gz